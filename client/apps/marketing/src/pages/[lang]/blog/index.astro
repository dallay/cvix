---
import GridContainer from "@/components/GridContainer.astro";
import BlogSearch from "@/components/blog/BlogSearch.vue";
import FeaturedPost from "@/components/blog/FeaturedPost.astro";
import Pagination from "@/components/Pagination.astro";
import { type Lang, LOCALES, useTranslations } from "@/i18n";
import Layout from "@/layouts/Base.astro";
import { getArticles } from "@/models/article";

const { lang } = Astro.params;
const currentLocale = lang as Lang;
const t = useTranslations(currentLocale);

// Get articles using the article service for consistency
const allArticles = await getArticles({
  lang: currentLocale,
});

// Separate the featured post (first one) from the rest
const featuredPost = allArticles[0];
const remainingArticles = allArticles.slice(1);

const title = t("blog.header.title");
const subtitle = t("blog.header.subtitle");

const postsPerPage = 16;
// Calculate pages based on remaining articles
const totalPages = Math.ceil(remainingArticles.length / postsPerPage);
const basePath = `/${currentLocale}/blog/page`;
const indexUrl = `/${currentLocale}/blog`;

export const getStaticPaths = () =>
  Object.keys(LOCALES).map((lang) => ({
    params: { lang },
  }));
---

<Layout title={title} description={subtitle}>
  <div class="container mx-auto px-4 py-8 md:py-12 space-y-12 md:space-y-20 mt-8 md:mt-16">
    <!-- Header & Search -->
    <div class="flex flex-col items-center gap-6 text-center">
      <div class="space-y-3">
        <h1 class="text-4xl md:text-5xl font-bold tracking-tight">{title}</h1>
        <p class="text-lg text-muted-foreground max-w-2xl">{subtitle}</p>
      </div>
      <div class="w-full max-w-xl">
        <BlogSearch client:load articles={allArticles} lang={currentLocale} />
      </div>
    </div>

    <!-- Featured Post -->
    {featuredPost && <FeaturedPost post={featuredPost} />}

    <!-- Recent Articles Grid -->
    <div class="space-y-12">
      <GridContainer posts={remainingArticles.slice(0, postsPerPage)} />

      <Pagination
        currentPage={1}
        lastPage={totalPages}
        urlPrev={null}
        urlNext={totalPages > 1 ? `${basePath}/2` : null}
        basePath={basePath}
        maxDisplayedPages={5}
        firstPageUrl={indexUrl}
      />
    </div>
  </div>
</Layout>

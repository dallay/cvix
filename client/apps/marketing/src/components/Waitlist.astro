---
import { CVIX_SUBSCRIBE_FORMS_URL } from "@cvix/lib";

interface Props {
	formId: string;
	title: string;
	description?: string;
	privacyText?: string;
}

const { formId, title, description, privacyText } = Astro.props;

// Get current locale from html lang attribute or default to "en"
const initialLocale = "en"; // Default - client will detect actual locale

// Default form configuration - single form ID for this waitlist instance
const formConfig = {
	id: formId,
	baseUrl: CVIX_SUBSCRIBE_FORMS_URL,
	locale: initialLocale,
};
---

<div class="waitlist-container w-full max-w-md mx-auto my-8">
	<div class="bg-card border border-border rounded-lg p-6 shadow-sm">
		<h3 class="text-xl font-semibold text-foreground mb-2">{title}</h3>
		{description && <p class="text-muted-foreground mb-4">{description}</p>}

		<div class="waitlist-form-wrapper">
			<iframe
				src={`${formConfig.baseUrl}/${formConfig.id}`}
				data-form-id={formConfig.id}
				data-base-url={formConfig.baseUrl}
				data-locale={formConfig.locale}
				class="cvix-waitlist-embed w-full"
				data-test-id={`cvix-waitlist-${formId}`}
				frameborder="0"
				scrolling="no"
				style="height: 180px; margin: 0; border-radius: 8px; background-color: transparent; box-shadow: 0 0 #0000;"
			></iframe>
		</div>

		{privacyText && <p class="text-xs text-muted-foreground mt-3">{privacyText}</p>}
	</div>
</div>

<script is:inline>
	(function() {
		// Prevent multiple initializations
		if (window.__cvixWaitlistInitialized) return;
		window.__cvixWaitlistInitialized = true;

		// Find all waitlist iframes on the page
		const iframes = document.querySelectorAll('iframe[data-test-id^="cvix-waitlist-"]');
		if (!iframes.length) return;

		// Store references and configs for each iframe
		const waitlistInstances = [];

		iframes.forEach((iframe) => {
			const baseUrl = iframe.getAttribute("data-base-url") || "";
			waitlistInstances.push({
				element: iframe,
				baseUrl: baseUrl,
			});
		});

		// Listen for messages from any waitlist iframe
		window.addEventListener(
			"message",
			function (e) {
				// Security: Only accept messages from allowed origins
				const allowedOrigins = waitlistInstances.map((w) => new URL(w.baseUrl).origin);
				if (!allowedOrigins.includes(e.origin)) return;

				const d = e.data || {};
				if (!d.id) return;

				// Find the matching iframe
				const matchingIframe = waitlistInstances.find(
					(w) => w.element.getAttribute("data-form-id") === d.id
				);
				if (!matchingIframe) return;

				const iframe = matchingIframe.element;

				switch (d.type) {
					case "cvix:height":
						iframe.style.height = (d.height || 180) + "px";
						break;
					case "cvix:submit:success":
						iframe.dispatchEvent(new CustomEvent("cvix:submit:success", { detail: d }));
						break;
					case "cvix:submit:error":
						iframe.dispatchEvent(new CustomEvent("cvix:submit:error", { detail: d }));
						break;
				}
			},
			false
		);
	})();
</script>

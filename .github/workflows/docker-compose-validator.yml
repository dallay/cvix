name: Docker Compose Validator

on:
  pull_request:
    paths:
      - 'infra/**.yml'
      - 'infra/**.yaml'
      - '.env.example'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8    # v6

      - name: Prepare environment file for validation
        run: |
          # Copy .env.example to .env for validation
          cp .env.example .env
          echo "âœ… Environment file prepared"

      - name: Validate individual compose files (syntax only)
        run: |
          cd infra
          echo "ðŸ” Validating compose file syntax..."
          # Validate individual files (will show warnings but won't fail on missing services)
          for file in greenmail/greenmail-compose.yml maildev/maildev-compose.yml; do
            if [[ -f "$file" ]]; then
              echo "Validating $file..."
              if ! docker compose -f "$file" config > /dev/null 2>&1; then
                echo "âŒ Syntax validation failed for $file"
                echo "Error details:"
                docker compose -f "$file" config 2>&1 | head -20
                exit 1
              fi
            fi
          done
          echo "âœ… Individual files validated"

      - name: Validate full stack composition
        run: |
          cd infra
          echo "ðŸ” Validating full stack with dependencies..."
          # Validate the main app.yml which includes all dependencies
          if ! docker compose -f app.yml config > /dev/null 2>&1; then
            echo "âŒ Full stack validation failed"
            echo "Error details:"
            docker compose -f app.yml config 2>&1 | head -50
            exit 1
          fi
          echo "âœ… Full stack validated successfully"

      - name: Validate PostgreSQL compose
        run: |
          cd infra/postgresql
          echo "ðŸ” Validating PostgreSQL compose..."
          if ! docker compose -f postgresql-compose.yml config > /dev/null 2>&1; then
            echo "âŒ PostgreSQL compose validation failed"
            echo "Error details:"
            docker compose -f postgresql-compose.yml config 2>&1 | head -20
            exit 1
          fi
          echo "âœ… PostgreSQL compose validated"

      - name: Cleanup
        if: always()
        run: |
          # Remove the temporary .env file
          rm -f .env
          echo "ðŸ§¹ Cleanup completed"

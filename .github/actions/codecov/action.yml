name: 'Upload Coverage to Codecov'
description: 'Uploads code coverage reports to Codecov if token is available'

inputs:
  codecov-token:
    description: 'Codecov token for uploading coverage reports'
    required: false
  files:
    description: 'Comma-separated list of coverage files to upload'
    required: true
  flags:
    description: 'Flag to identify coverage type (e.g., frontend, backend)'
    required: false
    default: ''
  name:
    description: 'Custom name for the upload'
    required: false
    default: ''
  fail-ci-if-error:
    description: 'Fail CI if Codecov upload fails'
    required: false
    default: 'false'
  verbose:
    description: 'Enable verbose output for debugging'
    required: false
    default: 'false'
  slug:
    description: 'Codecov slug'
    required: false
    default: 'dallay/cvix'

outputs:
  upload-failed:
    description: 'Whether the Codecov upload failed'
    value: ${{ steps.status.outputs.upload-failed }}

runs:
  using: "composite"
  steps:
    - name: Upload coverage to Codecov
      id: codecov
      # Pinned to v5 commit hash for security
      uses: codecov/codecov-action@5a1091511ad55cbe89839c7260b706298ca349f7  # v5
      if: inputs.codecov-token != ''
      continue-on-error: true
      with:
        files: ${{ inputs.files }}
        flags: ${{ inputs.flags }}
        name: ${{ inputs.name }}
        fail_ci_if_error: ${{ inputs.fail-ci-if-error }}
        verbose: ${{ inputs.verbose }}
        slug: ${{ inputs.slug }}
      env:
        CODECOV_TOKEN: ${{ inputs.codecov-token }}

    - name: Set upload status
      id: status
      shell: bash
      run: |
        if [ "${{ steps.codecov.outcome }}" == "failure" ]; then
          echo "upload-failed=true" >> $GITHUB_OUTPUT
        else
          echo "upload-failed=false" >> $GITHUB_OUTPUT
        fi

name: Docker Compose Validator

on:
  push:
    branches: [main, master, develop]
    paths:
      - 'infra/**/*.yml'
      - 'infra/**/*.yaml'
      - '.env.example'
      - 'infra/.env.example'
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'infra/**/*.yml'
      - 'infra/**/*.yaml'
      - '.env.example'
      - 'infra/.env.example'

jobs:
  validate:
    name: Validate Docker Compose Files
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8    # v6

      - name: Prepare environment files
        run: |
          echo "üì¶ Preparing environment files for validation..."
          
          # Copy root .env.example to infra directory if not exists
          if [ ! -f infra/.env.example ]; then
            echo "‚ö†Ô∏è  No infra/.env.example found, using root .env.example"
            cp .env.example infra/.env.example
          fi
          
          # Create .env from .env.example in infra directory
          cp infra/.env.example infra/.env
          
          echo "‚úÖ Environment files prepared"
          echo "üìã Environment variables loaded:"
          grep -v '^#' infra/.env | grep -v '^$' | wc -l | xargs echo "   Total variables:"

      - name: Validate individual compose files
        run: |
          cd infra
          echo ""
          echo "üîç Validating individual Docker Compose files..."
          echo "================================================"
          echo "   All compose files are now self-contained using 'include' directives"
          echo ""
          
          # Find all *-compose.yml files (excluding app.yml and app-stack.yml)
          COMPOSE_FILES=$(find . -type f -name "*-compose.yml" | sort)
          
          if [ -z "$COMPOSE_FILES" ]; then
            echo "‚ö†Ô∏è  No compose files found!"
            exit 1
          fi
          
          VALIDATED=0
          FAILED=0
          
          for file in $COMPOSE_FILES; do
            echo ""
            echo "üìÑ Validating: $file"
            
            # Validate syntax and variable interpolation
            if docker compose -f "$file" config > /dev/null 2>&1; then
              echo "   ‚úÖ Valid"
              VALIDATED=$((VALIDATED + 1))
            else
              echo "   ‚ùå Validation failed!"
              echo ""
              echo "   Error details:"
              docker compose -f "$file" config 2>&1 | head -30 | sed 's/^/      /'
              FAILED=$((FAILED + 1))
            fi
          done
          
          echo ""
          echo "================================================"
          echo "Summary: $VALIDATED validated, $FAILED failed"
          
          if [ $FAILED -gt 0 ]; then
            exit 1
          fi
          
          echo "‚úÖ All individual files validated successfully"

      - name: Validate common configuration
        run: |
          cd infra
          echo ""
          echo "üîç Validating common.yml..."
          echo "================================================"
          
          if docker compose -f common.yml config > /dev/null 2>&1; then
            echo "‚úÖ common.yml is valid"
          else
            echo "‚ùå common.yml validation failed!"
            echo ""
            echo "Error details:"
            docker compose -f common.yml config 2>&1 | head -30 | sed 's/^/   /'
            exit 1
          fi

      - name: Validate full application stack (with includes)
        run: |
          cd infra
          echo ""
          echo "üîç Validating app.yml (full stack with includes)..."
          echo "================================================"
          echo "   This file includes:"
          echo "     - common.yml"
          echo "     - postgresql/postgresql-compose.yml"
          echo "     - keycloak/keycloak-compose.yml"
          echo ""
          
          # Validate the main app.yml which includes dependencies
          if docker compose -f app.yml config > /dev/null 2>&1; then
            echo "‚úÖ Full stack validated successfully"
            echo ""
            echo "üìä Stack summary:"
            docker compose -f app.yml config --services | wc -l | xargs echo "   Total services:"
            echo "   Services:"
            docker compose -f app.yml config --services | sed 's/^/     - /'
          else
            echo "‚ùå Full stack validation failed!"
            echo ""
            echo "Error details:"
            docker compose -f app.yml config 2>&1 | head -50 | sed 's/^/   /'
            echo ""
            echo "üí° Common issues:"
            echo "   - Missing required environment variables"
            echo "   - Incorrect service references"
            echo "   - Invalid YAML syntax"
            echo "   - Circular dependencies"
            exit 1
          fi

      - name: Validate stack-compatible compose file
        run: |
          cd infra
          echo ""
          echo "üîç Validating app-stack.yml (Swarm-compatible)..."
          echo "================================================"
          echo "   This is the Swarm/Stack compatible version"
          echo "   (no 'include' directives, all merged inline)"
          echo ""
          
          if docker compose -f app-stack.yml config > /dev/null 2>&1; then
            echo "‚úÖ Stack file validated successfully"
            echo ""
            echo "üìä Stack summary:"
            docker compose -f app-stack.yml config --services | wc -l | xargs echo "   Total services:"
          else
            echo "‚ùå Stack validation failed!"
            echo ""
            echo "Error details:"
            docker compose -f app-stack.yml config 2>&1 | head -50 | sed 's/^/   /'
            exit 1
          fi

      - name: Check for hardcoded sensitive values
        run: |
          cd infra
          echo ""
          echo "üîê Checking for hardcoded sensitive values..."
          echo "================================================"
          
          # Look for actual hardcoded values, not just keys/labels
          # Patterns like: password: "actual_password" or token: abc123
          # Exclude: variables ${VAR}, secret definitions (file:, external:), comments
          
          FOUND_ISSUES=false
          
          # Check for passwords with actual values (not variables or file references)
          if grep -rE "(PASSWORD|SECRET|TOKEN|KEY)\s*=\s*['\"]?[a-zA-Z0-9]+" app.yml app-stack.yml | \
             grep -v '\${' | \
             grep -v 'changeme' | \
             grep -v 'example' > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Warning: Found potentially hardcoded credentials in environment variables"
            FOUND_ISSUES=true
          fi
          
          if [ "$FOUND_ISSUES" = false ]; then
            echo "‚úÖ No hardcoded sensitive values detected"
            echo ""
            echo "   Security checks passed:"
            echo "   ‚úì All passwords use variables or Docker secrets"
            echo "   ‚úì No plaintext credentials in compose files"
            echo "   ‚úì Secret definitions use file: or external: references"
          fi

      - name: Lint compose files with yamllint
        run: |
          echo ""
          echo "üßπ Linting YAML files..."
          echo "================================================"
          
          pip install yamllint
          
          echo "extends: default" > /tmp/yamllint-config.yml
          echo "rules:" >> /tmp/yamllint-config.yml
          echo "  line-length:" >> /tmp/yamllint-config.yml
          echo "    max: 150" >> /tmp/yamllint-config.yml
          echo "    level: warning" >> /tmp/yamllint-config.yml
          echo "  comments:" >> /tmp/yamllint-config.yml
          echo "    min-spaces-from-content: 1" >> /tmp/yamllint-config.yml
          echo "  indentation:" >> /tmp/yamllint-config.yml
          echo "    spaces: 2" >> /tmp/yamllint-config.yml
          echo "  truthy:" >> /tmp/yamllint-config.yml
          echo "    allowed-values: ['true', 'false', 'on']" >> /tmp/yamllint-config.yml
          echo "  document-start: disable" >> /tmp/yamllint-config.yml
          echo "  comments-indentation: disable" >> /tmp/yamllint-config.yml
          
          cd infra
          
          echo "Linting compose files..."
          find . -type f \( -name "*.yml" -o -name "*.yaml" \) -exec yamllint -c /tmp/yamllint-config.yml {} + || echo "‚ö†Ô∏è  Some YAML files have linting issues (warnings only)"
          
          echo ""
          echo "‚úÖ Linting completed"

      - name: Generate validation report
        if: always()
        run: |
          cd infra
          echo ""
          echo "üìä Validation Report"
          echo "================================================"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo ""
          echo "Compose files found:"
          find . -type f \( -name "*.yml" -o -name "*.yaml" \) | sed 's/^/   /'
          echo ""
          echo "‚úÖ All validations completed"

      - name: Cleanup
        if: always()
        run: |
          echo ""
          echo "üßπ Cleaning up temporary files..."
          rm -f infra/.env
          echo "‚úÖ Cleanup completed"

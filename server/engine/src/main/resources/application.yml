logging:
  pattern:
    console: "%d{dd-MM-yyyy HH:mm:ss} %magenta([%thread]) %highlight(%-5level) %logger.%M - %msg%n"
spring:
  application:
    name: ${application.name}
  jackson:
    # CRITICAL: Serialize dates as ISO-8601 strings, NOT as arrays
    # Without this, LocalDate serializes as [2018, 9, 5] instead of "2018-09-05"
    # NOTE: In Jackson 3 (Spring Boot 4), WRITE_DATES_AS_TIMESTAMPS moved from
    # SerializationFeature to DateTimeFeature, so we use datatype.datetime instead
    datatype:
      datetime:
        write-dates-as-timestamps: false
    # Also configure date format explicitly for consistency
    date-format: yyyy-MM-dd
  messages:
    basename: messages/messages
    encoding: UTF-8
  profiles:
    # Profile loading is now driven by the SPRING_PROFILES_ACTIVE environment variable.
    # Defaults to 'dev' if not set. Can be overridden by `--spring.profiles.active` on the command line or `-Dspring.profiles.active` in `JAVA_OPTS`.
    active: ${SPRING_PROFILES_ACTIVE:dev}
    group:
      dev:
        - dev
        - api-docs
        - tls
  liquibase:
    change-log: classpath:db/changelog/master.yaml
    enabled: true
    # JDBC URL for Liquibase migrations (Liquibase requires JDBC, not R2DBC)
    # This enables the "Dual Driver Strategy": Liquibase uses JDBC for schema management
    # while the application uses R2DBC for reactive database operations.
    url: ${LIQUIBASE_URL:jdbc:postgresql://localhost:5432/postgres}
    user: ${DATABASE_USERNAME:postgres}
    password: ${DATABASE_PASSWORD:postgres}
  main:
    allow-bean-definition-overriding: true
  security:
    oauth2:
      client:
        registration:
          oidc:
            client-secret: ${application.security.oauth2.client-secret}
            client-id: ${application.security.oauth2.client-id}
            scope: openid, profile, email, offline_access  # last one for refresh tokens
        provider:
          oidc:
            issuer-uri: ${application.security.oauth2.issuer-uri}
        resourceserver:
          jwt:
            audiences: ${application.security.oauth2.audience}
            jwk-set-uri: ${application.security.oauth2.issuer-uri}/protocol/openid-connect/certs
  r2dbc:
    url: ${DATABASE_URL:r2dbc:postgresql://localhost:5432/postgres}
    username: ${DATABASE_USERNAME:postgres}
    password: ${DATABASE_PASSWORD:postgres}
    pool:
      enabled: true
      initial-size: 10
      max-size: 20
  sql:
    init:
      mode: never
  cache:
    type: caffeine
    caffeine:
      spec: maximumSize=500,expireAfterWrite=5m
  mail:
    host: ${SMTP_HOST:localhost}
    port: ${SMTP_PORT:3025}
    username: ${SMTP_USERNAME:developer}
    password: ${SMTP_PASSWORD:secret}
    properties:
      mail:
        smtp:
          auth: false
          starttls:
            enable: false
          ssl:
            enable: false
application:
  name: ProFileTailors
  description: Example ProFileTailors application used as a starting point for projects.
  version: 0.0.1-SNAPSHOT
  security:
    oauth2:
      base-url: ${OAUTH2_SERVER_URL:http://localhost:9080}
      server-url: ${application.security.oauth2.base-url}
      issuer-uri: ${application.security.oauth2.base-url}/realms/${application.security.oauth2.realm}
      realm: ${REALM:ProFileTailors}
      client-id: ${CLIENT_ID:web_app}
      client-secret: ${CLIENT_SECRET:web_app}
      admin-client-id: ${ADMIN_CLIENT_ID:admin-cli}
      admin-realm: ${ADMIN_REALM:master}
      admin-username: ${ADMIN_REALM_USERNAME:admin}
      admin-password: ${ADMIN_REALM_PASSWORD:secret}
      audience:
        - account
        - api://default
    cors:
      allowed-origins: ${CORS_ALLOWED_ORIGINS}
      allowed-methods: ${CORS_ALLOWED_METHODS:GET,POST,PUT,DELETE,OPTIONS}
      allowed-headers: ${CORS_ALLOWED_HEADERS:Authorization,Content-Type,Accept,Origin,Access-Control-Request-Method,Access-Control-Request-Headers, X-Requested-With, X-Xsrf-Token, X-New-Header}
      exposed-headers: ${CORS_EXPOSED_HEADERS:Access-Control-Allow-Origin,Access-Control-Allow-Credentials}
      allow-credentials: ${CORS_ALLOW_CREDENTIALS:true}
      max-age: ${CORS_MAX_AGE:3600}
    domain: ${HOSTNAME:localhost}
  # Rate limiting configuration
  rate-limit:
    enabled: true
    # Cache configuration for rate limit buckets
    # Prevents unbounded memory growth with many unique identifiers
    cache:
      # Maximum number of cached buckets per instance
      max-size: ${RATELIMIT_CACHE_MAX_SIZE:10000}
      # Time-to-live in minutes for idle buckets
      ttl-minutes: ${RATELIMIT_CACHE_TTL_MINUTES:60}
    # Authentication endpoints rate limiting (time-based to prevent brute force attacks)
    auth:
      enabled: true
      endpoints:
        - /api/auth/login
        - /api/auth/register
        - /api/auth/password/reset
        - /api/auth/refresh-token
        - /api/auth/token/refresh
        - /api/auth/federated
      # Multiple limits can be applied simultaneously for better protection
      limits:
        # Short-term limit: prevents burst attacks
        - name: per-minute
          capacity: 10
          refill-tokens: 10
          refill-duration: 1m
        # Long-term limit: prevents sustained attacks
        - name: per-hour
          capacity: 100
          refill-tokens: 100
          refill-duration: 1h
    # Business endpoints rate limiting (pricing plan-based for API usage quotas)
    business:
      enabled: true
      pricing-plans:
        free:
          name: free-plan
          capacity: 20
          refill-tokens: 20
          refill-duration: 1h
        basic:
          name: basic-plan
          capacity: 40
          refill-tokens: 40
          refill-duration: 1h
        professional:
          name: professional-plan
          capacity: 100
          refill-tokens: 100
          refill-duration: 1h
    # Resume generation endpoints rate limiting
    resume:
      enabled: true
      endpoints:
        - /api/resume/generate
      limit:
        name: resume-per-minute
        capacity: 10
        refill-tokens: 10
        refill-duration: 1m
    # Waitlist endpoints rate limiting
    waitlist:
      enabled: true
      endpoints:
        - /api/waitlist
      limit:
        name: waitlist-per-minute
        capacity: 10
        refill-tokens: 10
        refill-duration: 1m
  contact:
    webhook-url: ${CONTACT_WEBHOOK_URL}
    header-api-key: YAP-AUTH-TOKEN
    api-key: ${CONTACT_API_KEY}
    form-token-id: ${CONTACT_FORM_TOKEN_ID}
    hcaptcha-secret-key: ${HCAPTCHA_SECRET_KEY}
management:
  endpoints:
    web:
      exposure:
        include:
          - health
          - info
          - prometheus
        # Restrict sensitive endpoints in production
        exclude:
          - configprops
          - env
          - logfile
          - loggers
          - threaddump
  endpoint:
    health:
      show-details: when-authorized
      show-components: when-authorized
      probes:
        enabled: true
  
  info:
    git:
      mode: full
    env:
      enabled: true
  prometheus:
    metrics:
      export:
        enabled: true
        step: 60
  observations:
    key-values:
      application: ${spring.application.name}
  metrics:
    enable:
      http: true
      jvm: true
      logback: true
      process: true
      system: true
    distribution:
      percentiles-histogram:
        all: true
      percentiles:
        all: 0, 0.5, 0.75, 0.95, 0.99, 1.0
    data:
      repository:
        autotime:
          enabled: true
    tags:
      application: ${spring.application.name}

resume:
  pdf:
    docker:
      # Use the full texlive image which includes pdflatex
      image: ${PDF_DOCKER_IMAGE:dallay/texlive:2025}
      max-concurrent-containers: ${PDF_MAX_CONCURRENT_CONTAINERS:10}
      timeout-seconds: ${PDF_TIMEOUT_SECONDS:30}
      memory-limit-mb: ${PDF_MEMORY_LIMIT_MB:512}
      cpu-quota: ${PDF_CPU_QUOTA:0.5}
  template:
    source:
      # Template source types (in order of priority - first wins on ID conflicts)
      # Free tier: [CLASSPATH]
      # Premium tier: [FILESYSTEM, CLASSPATH]
      types: ${TEMPLATE_SOURCE_TYPES:CLASSPATH}
      # Path to filesystem templates (only used when FILESYSTEM is in types)
      # Can be absolute or relative to the application working directory
      path: ${TEMPLATE_SOURCE_PATH:templates/resume}
waitlist:
  security:
    # HMAC secret for IP address hashing (required)
    # Must be set via WAITLIST_IP_HMAC_SECRET environment variable
    ip-hmac-secret: ${WAITLIST_IP_HMAC_SECRET:}
springdoc:
  show-actuator: true
  api-docs:
    enabled: true
  swagger-ui:
    enabled: true
    path: /api-docs
    csrf:
      enabled: true
    oauth:
      app-name: ${application.name}
      client-id: ${application.security.oauth2.client-id}
      client-secret: ${application.security.oauth2.client-secret}
# Properties to be exposed on the /info management endpoint
info:
  # Comma separated list of profiles that will trigger the ribbon to show
  display-ribbon-on-profiles: 'dev'

meta {
  name: Get CSRF Token
  type: http
  seq: 0
}

get {
  url: {{url}}/api/auth/csrf
  body: none
  auth: none
}

script:post-response {
  // Direct solution: get cookie and save variable synchronously
  const url = bru.getEnvVar('url');
  const jar = bru.cookies.jar();

  // Get the cookie - this is asynchronous but Bruno handles it internally
  jar.getCookie(url, 'XSRF-TOKEN').then(cookie => {
    if (cookie && cookie.value) {
      const xsrfToken = cookie.value;

      // Save immediately - WITHOUT await, WITHOUT setTimeout
      bru.setEnvVar('xsrfToken', xsrfToken);

      console.log('âœ… Token saved in xsrfToken variable');
      console.log('   Value:', xsrfToken.substring(0, 30) + '...');
      console.log('   Domain:', cookie.domain);
      console.log('   Path:', cookie.path);

      // Ensure the cookie is in the jar
      jar.setCookie(url, 'XSRF-TOKEN', xsrfToken);
      console.log('âœ… Cookie also saved in Cookie Jar');
    } else {
      console.log('âŒ XSRF-TOKEN cookie not found');
      console.log('ğŸ’¡ Verify that the server is sending the cookie');

      // Debug: show all cookies
      jar.getCookies().then(cookies => {
        console.log('ğŸ“‹ Available cookies:', cookies.length);
        cookies.forEach(c => console.log('  -', c.key, '=', c.value.substring(0, 20) + '...'));
      });
    }
  }).catch(error => {
    console.log('âŒ Error:', error.message);
  });
}

settings {
  encodeUrl: true
}

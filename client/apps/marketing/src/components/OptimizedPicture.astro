---
import {
	type LocalImageProps,
	Picture,
	type RemoteImageProps,
} from "astro:assets";
import type { ImageOutputFormat } from "astro";
import type { HTMLAttributes } from "astro/types";

type Props = (LocalImageProps | RemoteImageProps) & {
	formats?: ImageOutputFormat[];
	fallbackFormat?: ImageOutputFormat;
	pictureAttributes?: HTMLAttributes<"picture">;
	class?: string | null;
	/** Fallback image URL to use when the primary image fails to load */
	fallbackSrc?: string;
};

const {
	formats = ["avif", "webp"],
	fallbackFormat = "avif",
	// Use undefined as the default so the prop is omitted when not explicitly set.
	// Some runtimes/types include 'auto' for loading, but Astro's Picture
	// typing expects 'eager' | 'lazy' | null | undefined. Default to undefined
	// and map 'auto' below to avoid type errors.
	loading = undefined,
	fetchpriority = "auto",
	class: className = "mx-auto w-full max-w-full rounded-lg",
	fallbackSrc,
	...props
} = Astro.props;

// Normalize loading to the narrower set accepted by Astro's Picture.
// Read the raw prop in a permissive way so we can handle 'auto' when present
// without causing a TypeScript incompatible comparison.
const rawLoading =
	((Astro.props as unknown as Record<string, unknown>).loading as
		| string
		| undefined) ?? loading;
const picLoading: "eager" | "lazy" | null | undefined =
	rawLoading === "auto"
		? undefined
		: (rawLoading as "eager" | "lazy" | null | undefined);

// Generate unique ID for fallback handling (always generated, but only used when fallback is provided)
const wrapperId = `img-wrapper-${crypto.randomUUID()}`;
---

<div id={wrapperId} data-fallback-src={fallbackSrc} data-wrapper-id={wrapperId} class="contents">
	<Picture
		{...props}
		formats={formats}
		fallbackFormat={fallbackFormat}
		loading={picLoading}
		fetchpriority={fetchpriority}
		class={className}
	/>
</div>

{fallbackSrc && (
	<script is:inline>
		// Handle image fallback - scoped to this specific component instance
		// Uses data attributes to read wrapperId and fallbackSrc from the DOM
		(function initImageFallback() {
			// Find the wrapper that was just added (last one without initialized flag)
			const wrappers = document.querySelectorAll('[data-fallback-src]:not([data-fallback-initialized])');
			const wrapper = wrappers[wrappers.length - 1];
			
			if (wrapper) {
				wrapper.setAttribute('data-fallback-initialized', 'true');
				
				const fallbackSrc = wrapper.getAttribute('data-fallback-src');
				if (!fallbackSrc) return;
				
				const img = wrapper.querySelector('img');
				if (img) {
					// Set fallback image on error
					img.addEventListener('error', function handleImageError() {
						// Normalize URLs for proper comparison (img.src is always absolute in DOM)
						const currentSrc = new URL(this.src, document.baseURI).href;
						const fallbackFullUrl = new URL(fallbackSrc, document.baseURI).href;
						
						// Prevent infinite loop if fallback also fails
						if (currentSrc !== fallbackFullUrl) {
							this.src = fallbackSrc;
						}
					}, { once: true });
				}
			}
		})();
	</script>
)}

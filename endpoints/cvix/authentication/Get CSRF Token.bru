meta {
  name: Get CSRF Token
  type: http
  seq: 0
}

get {
  url: {{url}}/api/auth/csrf
  body: none
  auth: none
}

script:post-response {
  // SoluciÃ³n directa: obtener cookie y guardar variable sincrÃ³nicamente
  const url = bru.getEnvVar('url');
  const jar = bru.cookies.jar();

  // Obtener la cookie - esto es asÃ­ncrono pero Bruno lo maneja internamente
  jar.getCookie(url, 'XSRF-TOKEN').then(cookie => {
    if (cookie && cookie.value) {
      const xsrfToken = cookie.value;

      // Guardar inmediatamente - SIN await, SIN setTimeout
      bru.setEnvVar('xsrfToken', xsrfToken);

      console.log('âœ… Token guardado en variable xsrfToken');
      console.log('   Valor:', xsrfToken.substring(0, 30) + '...');
      console.log('   Dominio:', cookie.domain);
      console.log('   Path:', cookie.path);

      // Asegurar que la cookie estÃ¡ en el jar
      jar.setCookie(url, 'XSRF-TOKEN', xsrfToken);
      console.log('âœ… Cookie tambiÃ©n guardada en Cookie Jar');
    } else {
      console.log('âŒ No se encontrÃ³ cookie XSRF-TOKEN');
      console.log('ğŸ’¡ Verifica que el servidor estÃ© enviando la cookie');

      // Debug: mostrar todas las cookies
      jar.getCookies().then(cookies => {
        console.log('ğŸ“‹ Cookies disponibles:', cookies.length);
        cookies.forEach(c => console.log('  -', c.key, '=', c.value.substring(0, 20) + '...'));
      });
    }
  }).catch(error => {
    console.log('âŒ Error:', error.message);
  });
}

settings {
  encodeUrl: true
}

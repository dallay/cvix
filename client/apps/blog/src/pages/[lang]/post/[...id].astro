---
import { render } from "astro:content";
import { OptimizedPicture } from "@cvix/astro-ui";
import { isImageMetadata } from "@cvix/astro-ui/image/image-utils.ts";
import PostFooter from "@/components/PostFooter.astro";
import PostHeader from "@/components/PostHeader.astro";
import TableOfContents from "@/components/TableOfContents.astro";
import Waitlist from "@/components/Waitlist.astro";
import { type Lang, useTranslations } from "@/i18n/i18n.ts";
import Layout from "@/layouts/Article.astro";
import { getArticles } from "@/models/article";
import type Article from "@/models/article/article.model";
import { prepareImageForOptimizedPicture } from "@/utils/images";

const currentLocale = Astro.currentLocale as Lang;
const t = useTranslations(currentLocale);

interface Props {
	post: Article;
}

export async function getStaticPaths() {
	const posts = await getArticles();

	return posts.map((post) => {
		const [lang, ...id] = post.id.split("/");
		return { params: { lang, id: id.join("/") || undefined }, props: { post } };
	});
}

const { post } = Astro.props;

if (!post.entry) {
	throw new Error(`No entry found for post: ${post.id}`);
}

const { Content, headings, remarkPluginFrontmatter } = await render(post.entry);

// Prepare the cover image for rendering
const coverImage = post.cover
	? await prepareImageForOptimizedPicture(post.cover)
	: undefined;

const schema = {
	"@context": "https://schema.org",
	"@type": "BlogPosting",
	headline: post.title,
	description: post.description,
	image: coverImage && isImageMetadata(coverImage) ? coverImage.src : undefined,
	datePublished: post.date,
	author: {
		"@type": "Person",
		name: post.author?.name || "CVIX Team",
	},
};
---

<Layout {...post} url={Astro.request.url} minutesRead={remarkPluginFrontmatter.minutesRead}>
  <script is:inline type="application/ld+json" set:html={JSON.stringify(schema)} />

  <div class="container mx-auto px-4 py-12">
    <div class="grid grid-cols-1 lg:grid-cols-12 gap-12">
      <!-- Main Content -->
      <article class="lg:col-span-8">
        <PostHeader post={post} readingTime={remarkPluginFrontmatter.minutesRead} />

        <!-- Mobile TOC - visible only on mobile/tablet -->
        {
          headings && headings.length > 0 && (
            <div class="block lg:hidden mb-8 border border-border rounded-xl bg-card overflow-hidden">
              <button
                type="button"
                id="mobile-toc-toggle"
                class="w-full flex items-center justify-between p-4 text-left font-semibold text-foreground hover:bg-muted/50 transition-colors focus:outline-none focus:ring-2 focus:ring-primary focus:ring-inset"
                aria-expanded="false"
                aria-controls="mobile-toc-content"
              >
                <span class="text-base">{t("blog.tableOfContents")}</span>
                <svg
                  class="w-5 h-5 transition-transform duration-200"
                  aria-hidden="true"
                  fill="none"
                  stroke="currentColor"
                  viewBox="0 0 24 24"
                >
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M19 9l-7 7-7-7"
                  />
                </svg>
              </button>
              <div
                id="mobile-toc-content"
                class="hidden p-4 pt-0 border-t border-border"
                aria-labelledby="mobile-toc-toggle"
              >
                <TableOfContents headings={headings} lang={currentLocale} />
              </div>
            </div>
          )
        }

        <script>
          // Mobile TOC toggle functionality
          document.addEventListener("DOMContentLoaded", () => {
            const toggleButton = document.getElementById("mobile-toc-toggle");
            const tocContent = document.getElementById("mobile-toc-content");

            if (toggleButton && tocContent) {
              toggleButton.addEventListener("click", () => {
                const isExpanded = toggleButton.getAttribute("aria-expanded") === "true";
                const newState = !isExpanded;

                // Update ARIA state
                toggleButton.setAttribute("aria-expanded", String(newState));

                // Toggle content visibility
                tocContent.classList.toggle("hidden");

                // Rotate chevron icon
                const icon = toggleButton.querySelector("svg");
                if (icon) {
                  icon.style.transform = newState ? "rotate(180deg)" : "rotate(0deg)";
                }

                // Set focus to first link when opening
                if (newState) {
                  const firstLink = tocContent.querySelector("a");
                  if (firstLink) {
                    // Small delay to ensure content is visible
                    setTimeout(() => {
                      (firstLink as HTMLElement).focus();
                    }, 100);
                  }
                }
              });

              // Allow keyboard users to close TOC with Escape
              tocContent.addEventListener("keydown", (e) => {
                if (e.key === "Escape") {
                  toggleButton.click();
                  toggleButton.focus();
                }
              });
            }
          });
        </script>

        {
          isImageMetadata(coverImage) && (
            <div class="my-8 rounded-xl overflow-hidden shadow-md">
              <OptimizedPicture src={coverImage} alt={post.title} loading="eager" class="w-full" />
            </div>
          )
        }

        <div
          class="prose prose-lg dark:prose-invert max-w-none prose-headings:font-bold prose-a:text-primary hover:prose-a:text-primary/80 prose-img:rounded-xl"
        >
          <Content />
        </div>

        <div class="mt-12 pt-8 border-t border-border">
          <PostFooter post={post} />
        </div>
      </article>

      <!-- Sidebar -->
      <aside class="hidden lg:block lg:col-span-4 space-y-8">
        <div class="sticky top-24 space-y-8">
          <div class="p-6 bg-card rounded-xl border border-border shadow-sm">
            <TableOfContents headings={headings} lang={currentLocale} />
          </div>

          <div class="p-6 bg-muted/50 rounded-xl border border-border/50">
            <Waitlist formId="sidebar-waitlist-form" title="" description="" class="w-full" />
          </div>
        </div>
      </aside>
    </div>
  </div>

  <div class="border-t border-border mt-20 bg-muted/30">
    <div class="container mx-auto px-4 py-16">
      <div class="max-w-3xl mx-auto text-center">
        <Waitlist
          formId="article-bottom-waitlist-form"
          title=""
          description=""
          class="max-w-md mx-auto"
        />
      </div>
    </div>
  </div>
</Layout>

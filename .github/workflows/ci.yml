name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to run tests against"
        type: choice
        options:
          - development
          - staging
        default: "development"
        required: true

concurrency:
  group: ${{ github.workflow }}${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write
  security-events: write # Required for CodeQL to upload results

jobs:
  lint-meta:
    name: Lint Meta-Files
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write # For reviewdog to post comments
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Lint YAML files
        uses: ibiqlik/action-yamllint@ae1abb2821b567e96742aa776f7b62c9b6a26bc8 #v3
        with:
          file_or_dir: "."
          config_file: ".yamllint.yml"

      - name: Lint GitHub Actions
        uses: reviewdog/action-actionlint@v1.68.0 # use released tag instead of commit SHA to avoid missing-tarball errors
        with:
          reporter: github-pr-review
          fail_level: error

      - name: Lint Shell scripts
        uses: reviewdog/action-shellcheck@f627b974d3005f993dc36f46d2cdf2684be18e5c # v1.9.0
        with:
          reporter: github-pr-review
          fail_on_error: true
          path: "scripts/"
          pattern: "*.sh"

      - name: Lint Dockerfiles
        uses: hadolint/hadolint-action@2332a7b74a6de0dda2e2221d575162eba76ba5e5 # v3.3.0
        with:
          dockerfile: "Dockerfile"
          recursive: true
          config: ".hadolint.yaml"
          output-file: "/dev/stdout"
          format: "tty"
          failure-threshold: "error"
          ignore: "DL3008,DL4006" # Example: ignore rules, customize as needed

      - name: Lint JSON files
        run: |
          find . -type f -name "*.json" -not -path "*/node_modules/*" -not -path "*/dist/*" -not -path "*/build/*" \
            -exec jq . {} \; > /dev/null
        shell: bash

  labeler:
    name: Label PRs
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Run Labeler
        uses: actions/labeler@v3
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yaml

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    permissions:
      contents: read # Required to read dependency files
      pull-requests: write # Required to comment on PRs
    steps:
      - name: Checkout repository
        # Pinned to v4 commit hash for security
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Dependency Review
        # Pinned to v4 commit hash for security
        uses: actions/dependency-review-action@45529485b5eb76184ced07362d2331fd9d26f03f # v4
        continue-on-error: true # Allow workflow to continue if dependency graph or GitHub Advanced Security is not enabled
        with:
          # You can specify configuration options here, e.g.:
          # fail-on-severity: critical
          # allow-licenses: Apache-2.0, MIT
          # deny-licenses: GPL-3.0
          comment-summary-in-pr: always # Add a summary comment to PRs

  owasp-dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    permissions:
      contents: read # To read dependency files
      # issues: write   # If you want to create issues for vulnerabilities (optional)
      # pull-requests: write   # If you want to comment on PRs (optional)
    steps:
      - name:
          Checkout repository
          # Pinned to v4 commit hash for security
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@2ba636726705b0f74f126ebeaacaf2ad4600b967
        with:
          project: "Loomify-monorepo"
          path: "."
          format: "HTML" # You can choose other formats like XML, JSON, CSV
          # Optional: specify suppression file if you have one
          # suppressionPath: 'config/owasp/owasp-suppression.xml'
          # Optional: fail the build if vulnerabilities are found
          # Optional: Upload the report as an artifact
      - name: Upload OWASP Dependency Check Report
        if: always() # Ensure report is uploaded even if previous steps fail
        # Pinned to v4 commit hash for security
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: owasp-dependency-check-report
          path: reports/dependency-check-report.html # Default path for HTML report
          retention-days: 7

  backend:
    name: Backend
    uses: ./.github/workflows/backend-ci.yml
    secrets:
      NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  frontend:
    name: Frontend
    uses: ./.github/workflows/frontend-ci.yml
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  test:
    name: Test
    needs: [backend, frontend]
    runs-on: ubuntu-latest

    steps:
      - name:
          Checkout repository
          # Pinned to v4 commit hash for security
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Java
        uses: ./.github/actions/setup/java
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup/node
        with:
          node-version: "22"

      - name:
          Download backend artifacts
          # Pinned to v4 commit hash for security
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: backend-artifacts
          path: backend-artifacts

      - name:
          Download frontend artifacts
          # Pinned to v4 commit hash for security
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: frontend-artifacts
          path: frontend-artifacts

      - name: Run tests
        run: |
          cd backend
          ./gradlew test

      - name: Generate test report
        run: |
          mkdir -p test-report
          cp backend/build/reports/tests/test/* test-report/ || true

      - name:
          Upload test report
          # Pinned to v4 commit hash for security
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: test-report
          path: test-report/
          retention-days: 7

  markdown:
    name: Markdown lint (docs)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Markdownlint
        uses: DavidAnson/markdownlint-cli2-action@451cad2cde7304d9c243aaaf2e894d74b428c4be
        with:
          globs: |
            **/*.md
            **/*.mdx
            !.github/copilot-instructions.md
            !.github/prompts/*speckit*
            !.specify/**
            !CLAUDE.md
            !GEMINI.md
            !node_modules/**
            !dist/**
            !build/**
          config: .markdownlint.json

name: Docker Compose Validator

on:
  push:
    branches: [main, master, develop]
    paths:
      - 'infra/**/*.yml'
      - 'infra/**/*.yaml'
      - '.env.example'
      - 'infra/.env.example'
  pull_request:
    branches: [main, master, develop]
    paths:
      - 'infra/**/*.yml'
      - 'infra/**/*.yaml'
      - '.env.example'
      - 'infra/.env.example'

# Avoid redundant workflow runs on the same branch
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  validate:
    name: Validate Docker Compose Files
    runs-on: ubuntu-latest

    # Set working directory once for all steps
    defaults:
      run:
        working-directory: infra

    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8    # v6

      - name: Cache pip dependencies
        uses: actions/cache@v4
        with:
          path: ~/.cache/pip
          key: ${{ runner.os }}-pip-yamllint-1.37.1
          restore-keys: |
            ${{ runner.os }}-pip-

      - name: Prepare environment files
        run: |
          echo "üì¶ Preparing environment files for validation..."

          # Verify root .env.example exists before attempting operations
          if [ ! -f ../.env.example ]; then
            echo "‚ùå ERROR: Root .env.example does not exist!"
            echo "   This file is required for CI validation."
            echo "   Please ensure .env.example is committed to the repository."
            exit 1
          fi

          # Copy root .env.example to infra directory if not exists
          if [ ! -f .env.example ]; then
            echo "‚ö†Ô∏è  No infra/.env.example found, using root .env.example"
            cp ../.env.example .env.example
          fi

          # Create .env from .env.example in infra directory
          cp .env.example .env

          echo "‚úÖ Environment files prepared"
          echo "üìã Environment variables loaded:"
          VAR_COUNT=$(grep -cv '^#\|^$' .env || echo "0")
          echo "   Total variables: $VAR_COUNT"

      - name: Validate compose file naming conventions
        run: |
          echo ""
          echo "üìù Validating compose file naming conventions..."
          echo "================================================"
          echo "   Enforcing consistent naming patterns"
          echo ""

          NAMING_ISSUES=false

          # Check for inconsistent naming patterns
          # Expected: <service>-compose.yml or docker-compose-<service>.yml
          # Special files: app.yml, app-stack.yml, common.yml

          echo "üìã Compose files discovered:"
          find . -type f \
            \( -name "*.yml" -o -name "*.yaml" \) \
            -not -path "./.github/*" \
            | sort | sed 's/^/   /'
          echo ""

          # Check for files that might be compose files but don't follow naming convention
          SUSPICIOUS_FILES=$(find . -type f \
            \( -name "*.yml" -o -name "*.yaml" \) \
            -not -path "./.github/*" \
            -not -name "*compose*.yml" \
            -not -name "*compose*.yaml" \
            -not -name "docker-compose*.yml" \
            -not -name "app.yml" \
            -not -name "app-stack.yml" \
            -not -name "common.yml" \
            | grep -E "services:|version:|networks:|volumes:" 2>/dev/null || true)

          if [ -n "$SUSPICIOUS_FILES" ]; then
            echo "‚ö†Ô∏è  Found YAML files that might be compose files but don't follow naming convention:"
            echo "$SUSPICIOUS_FILES" | sed 's/^/   /'
            echo ""
            echo "   Expected patterns:"
            echo "   - <service>-compose.yml (e.g., postgresql-compose.yml)"
            echo "   - docker-compose-<service>.yml"
            echo "   - app.yml, app-stack.yml, common.yml (special files)"
            NAMING_ISSUES=true
          fi

          if [ "$NAMING_ISSUES" = false ]; then
            echo "‚úÖ All compose files follow naming conventions"
          else
            echo ""
            echo "üí° Consider renaming files to follow project conventions"
            # Don't fail - just warn for now
          fi

      - name: Validate individual compose files
        run: |
          set -euo pipefail  # Strict error handling

          echo ""
          echo "üîç Validating individual Docker Compose files..."
          echo "================================================"
          echo "   Using dynamic discovery for all compose files"
          echo "   Pattern: *compose*.yml, *compose*.yaml, docker-compose*.yml"
          echo ""

          # Dynamic discovery: Find all compose files recursively
          # Patterns: *compose*.yml, *compose*.yaml, docker-compose*.yml, docker-compose*.yaml
          # Exclude: .github directory (workflow files), app.yml and app-stack.yml (validated separately)
          COMPOSE_FILES=$(find . -type f \
            \( -name "*compose*.yml" -o -name "*compose*.yaml" -o -name "docker-compose*.yml" -o -name "docker-compose*.yaml" \) \
            -not -path "./.github/*" \
            -not -name "app.yml" \
            -not -name "app-stack.yml" \
            -not -name "common.yml" \
            | sort)

          if [ -z "$COMPOSE_FILES" ]; then
            echo "::error::No compose files found in expected locations"
            echo "   Searched for: *compose*.yml, *compose*.yaml, docker-compose*.yml"
            echo "   Excluded: .github/, app.yml, app-stack.yml, common.yml"
            exit 1
          fi

          echo "üìã Discovered files:"
          echo "$COMPOSE_FILES" | sed 's/^/   /'
          echo ""

          VALIDATED=0
          FAILED=0
          FAILED_FILES=""

          for file in $COMPOSE_FILES; do
            echo "::group::Validating $file"

            # Validate syntax and variable interpolation
            if OUTPUT=$(docker compose -f "$file" config 2>&1); then
              echo "   ‚úÖ Valid"
              VALIDATED=$((VALIDATED + 1))
            else
              echo "::error file=$file::Docker Compose validation failed"
              echo "   ‚ùå Validation failed!"
              echo ""
              echo "   Error details:"
              echo "$OUTPUT" | head -30 | sed 's/^/      /'
              FAILED=$((FAILED + 1))
              FAILED_FILES="$FAILED_FILES\n   - $file"
            fi

            echo "::endgroup::"
          done

          echo ""
          echo "================================================"
          echo "Summary: $VALIDATED validated, $FAILED failed"

          if [ $FAILED -gt 0 ]; then
            echo ""
            echo "‚ùå Failed files:"
            echo -e "$FAILED_FILES"
            exit 1
          fi

          echo "‚úÖ All individual files validated successfully"

      - name: Validate common configuration
        run: |
          echo ""
          echo "üîç Validating common.yml..."
          echo "================================================"

          if docker compose -f common.yml config > /dev/null 2>&1; then
            echo "‚úÖ common.yml is valid"
          else
            echo "‚ùå common.yml validation failed!"
            echo ""
            echo "Error details:"
            docker compose -f common.yml config 2>&1 | head -30 | sed 's/^/   /'
            exit 1
          fi

      - name: Validate full application stack (with includes)
        run: |
          echo ""
          echo "üîç Validating app.yml (full stack with includes)..."
          echo "================================================"
          echo "   This file includes:"
          echo "     - common.yml"
          echo "     - postgresql/postgresql-compose.yml"
          echo "     - keycloak/keycloak-compose.yml"
          echo ""

          # Validate the main app.yml which includes dependencies
          if docker compose -f app.yml config > /dev/null 2>&1; then
            echo "‚úÖ Full stack validated successfully"
            echo ""
            echo "üìä Stack summary:"
            SERVICE_COUNT=$(docker compose -f app.yml config --services | wc -l)
            echo "   Total services: $SERVICE_COUNT"
            echo "   Services:"
            docker compose -f app.yml config --services | sed 's/^/     - /'
          else
            echo "‚ùå Full stack validation failed!"
            echo ""
            echo "Error details:"
            docker compose -f app.yml config 2>&1 | head -50 | sed 's/^/   /'
            echo ""
            echo "üí° Common issues:"
            echo "   - Missing required environment variables"
            echo "   - Incorrect service references"
            echo "   - Invalid YAML syntax"
            echo "   - Circular dependencies"
            exit 1
          fi

      - name: Validate stack-compatible compose file
        run: |
          echo ""
          echo "üîç Validating app-stack.yml (Swarm-compatible)..."
          echo "================================================"
          echo "   This is the Swarm/Stack compatible version"
          echo "   (no 'include' directives, all merged inline)"
          echo ""

          if docker compose -f app-stack.yml config > /dev/null 2>&1; then
            echo "‚úÖ Stack file validated successfully"
            echo ""
            echo "üìä Stack summary:"
            SERVICE_COUNT=$(docker compose -f app-stack.yml config --services | wc -l)
            echo "   Total services: $SERVICE_COUNT"
          else
            echo "‚ùå Stack validation failed!"
            echo ""
            echo "Error details:"
            docker compose -f app-stack.yml config 2>&1 | head -50 | sed 's/^/   /'
            exit 1
          fi

      - name: Check for hardcoded sensitive values
        run: |
          echo ""
          echo "üîê Checking for hardcoded sensitive values..."
          echo "================================================"

          # Look for actual hardcoded values, not just keys/labels
          # Patterns like: password: "actual_password" or token: abc123
          # Exclude: variables ${VAR}, secret definitions (file:, external:), comments

          FOUND_ISSUES=false

          # Check for passwords with actual values (not variables or file references)
          if grep -rE "(PASSWORD|SECRET|TOKEN|KEY)\s*=\s*['\"]?[a-zA-Z0-9]+" app.yml app-stack.yml | \
             grep -v '\${' | \
             grep -v 'changeme' | \
             grep -v 'example' > /dev/null 2>&1; then
            echo "‚ö†Ô∏è  Warning: Found potentially hardcoded credentials in environment variables"
            FOUND_ISSUES=true
          fi

          if [ "$FOUND_ISSUES" = false ]; then
            echo "‚úÖ No hardcoded sensitive values detected"
            echo ""
            echo "   Security checks passed:"
            echo "   ‚úì All passwords use variables or Docker secrets"
            echo "   ‚úì No plaintext credentials in compose files"
            echo "   ‚úì Secret definitions use file: or external: references"
          fi

      - name: Quality Gate - TODO/FIXME Audit
        run: |
          echo ""
          echo "üîç Scanning for TODO/FIXME markers..."
          echo "================================================"
          echo "   Branch: ${{ github.ref_name }}"
          echo "   Strategy: Block on main/master, warn on feature branches"
          echo ""

          # Search for TODO, FIXME, XXX, HACK markers in compose files
          # Exclude comments that are just documentation headers
          FOUND_MARKERS=false

          if grep -rn "TODO\|FIXME\|XXX\|HACK" \
             --include="*.yml" \
             --include="*.yaml" \
             --exclude-dir=".github" \
             . 2>/dev/null | grep -v "^#.*TODO.*:" ; then
            echo ""
            echo "‚ö†Ô∏è  Found TODO/FIXME markers in compose files"
            echo ""
            echo "   These markers indicate incomplete work or known issues."
            FOUND_MARKERS=true
          fi

          if [ "$FOUND_MARKERS" = true ]; then
            # Branch-specific governance
            BRANCH="${{ github.ref_name }}"

            if [[ "$BRANCH" =~ ^(main|master)$ ]]; then
              echo ""
              echo "‚ùå ERROR: Technical debt markers NOT allowed in production branches"
              echo "   Branch: $BRANCH"
              echo "   Action: Please resolve all TODO/FIXME markers before merging"
              exit 1
            else
              echo ""
              echo "‚ö†Ô∏è  Warning: Technical debt markers found (not blocking on $BRANCH)"
              echo "   Consider resolving before merging to production"
            fi
          else
            echo "‚úÖ No TODO/FIXME markers found"
            echo ""
            echo "   Quality checks passed:"
            echo "   ‚úì No outstanding TODO markers"
            echo "   ‚úì No FIXME markers"
            echo "   ‚úì Infrastructure code is production-ready"
          fi

      - name: Lint compose files with yamllint
        run: |
          echo ""
          echo "üßπ Linting YAML files..."
          echo "================================================"

          # Install yamllint (cached by pip cache action)
          pip install --quiet yamllint==1.37.1

          # Create yamllint configuration using heredoc for readability
          cat > /tmp/yamllint-config.yml << 'YAMLLINTEOF'
          extends: default
          rules:
            line-length:
              max: 150
              level: warning
            comments:
              min-spaces-from-content: 1
            indentation:
              spaces: 2
            truthy:
              allowed-values: ['true', 'false', 'on']
            document-start: disable
            comments-indentation: disable
          YAMLLINTEOF

          echo "Linting compose files..."
          # Use find to get relative paths for better error messages
          find . -type f \( -name "*.yml" -o -name "*.yaml" \) \
            -not -path "./.github/*" \
            -exec yamllint -c /tmp/yamllint-config.yml {} + \
            || {
              echo ""
              echo "::error::yamllint found issues in compose files"
              echo "Fix linting errors or update yamllint configuration if needed"
              exit 1
            }

          echo ""
          echo "‚úÖ Linting completed successfully"

      - name: Generate validation report
        if: always()
        run: |
          echo ""
          echo "üìä Validation Report"
          echo "================================================"
          echo "Repository: ${{ github.repository }}"
          echo "Branch: ${{ github.ref_name }}"
          echo "Commit: ${{ github.sha }}"
          echo ""

          # Count different types of compose files
          TOTAL_COMPOSE=$(find . -type f \
            \( -name "*compose*.yml" -o -name "*compose*.yaml" -o -name "docker-compose*.yml" \) \
            -not -path "./.github/*" | wc -l)

          INDIVIDUAL_COMPOSE=$(find . -type f \
            \( -name "*compose*.yml" -o -name "*compose*.yaml" -o -name "docker-compose*.yml" \) \
            -not -path "./.github/*" \
            -not -name "app.yml" \
            -not -name "app-stack.yml" \
            -not -name "common.yml" | wc -l)

          echo "üìà Statistics:"
          echo "   Total compose files: $TOTAL_COMPOSE"
          echo "   Individual service files: $INDIVIDUAL_COMPOSE"
          echo "   Stack files: 2 (app.yml, app-stack.yml)"
          echo "   Common config: 1 (common.yml)"
          echo ""

          echo "üìã All compose files:"
          find . -type f \
            \( -name "*.yml" -o -name "*.yaml" \) \
            -not -path "./.github/*" \
            | sort | sed 's/^/   /'
          echo ""

          # Check job status to provide accurate final message
          if [ "${{ job.status }}" = "success" ]; then
            echo "‚úÖ All validations completed successfully"
            echo ""
            echo "üéâ Infrastructure is ready for deployment!"
          else
            echo "‚ùå Some validations failed ‚Äî check previous steps for errors"
            echo ""
            echo "üí° Common failure causes:"
            echo "   - Invalid YAML syntax in compose files"
            echo "   - Missing required environment variables"
            echo "   - Hardcoded sensitive values detected"
            echo "   - yamllint errors (line-length, indentation, etc.)"
            echo "   - Network conflicts or missing includes"
          fi

      - name: Cleanup
        if: always()
        run: |
          echo ""
          echo "üßπ Cleaning up temporary files..."
          rm -f infra/.env
          echo "‚úÖ Cleanup completed"

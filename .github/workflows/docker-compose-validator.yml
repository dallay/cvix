name: Docker Compose Validator

on:
  pull_request:
    paths:
      - 'infra/**.yml'
      - 'infra/**.yaml'
      - '.env.example'

jobs:
  validate:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@8e8c483db84b4bee98b60c0593521ed34d9990e8    # v6

      - name: Prepare environment file for validation
        run: |
          # Copy .env.example to .env for validation
          cp .env.example .env
          echo "‚úÖ Environment file prepared"

      - name: Validate individual compose files (syntax only)
        run: |
          cd infra
          echo "üîç Validating compose file syntax..."
          
          # Validate individual files (will show warnings but won't fail on missing services)
          for file in greenmail/greenmail-compose.yml maildev/maildev-compose.yml; do
            if [[ -f "$file" ]]; then
              echo "Validating $file..."
              docker compose -f "$file" config > /dev/null || {
                echo "‚ùå Syntax validation failed for $file"
                exit 1
              }
            fi
          done
          
          echo "‚úÖ Individual files validated"

      - name: Validate full stack composition
        run: |
          cd infra
          echo "üîç Validating full stack with dependencies..."
          
          # Validate the main app.yml which includes all dependencies
          docker compose -f app.yml config > /dev/null || {
            echo "‚ùå Full stack validation failed"
            exit 1
          }
          
          echo "‚úÖ Full stack validated successfully"

      - name: Validate PostgreSQL compose
        run: |
          cd infra/postgresql
          echo "üîç Validating PostgreSQL compose..."
          docker compose -f postgresql-compose.yml config > /dev/null || {
            echo "‚ùå PostgreSQL compose validation failed"
            exit 1
          }
          echo "‚úÖ PostgreSQL compose validated"

      - name: Cleanup
        if: always()
        run: |
          # Remove the temporary .env file
          rm -f .env
          echo "üßπ Cleanup completed"

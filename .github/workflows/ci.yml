name: CI

on:
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to run tests against"
        type: choice
        options:
          - development
          - staging
        default: "development"
        required: true

concurrency:
  group: ${{ github.workflow }}-${{ github.head_ref || github.ref_name }}
  cancel-in-progress: true

permissions:
  contents: read
  checks: write
  pull-requests: write
  security-events: write # Required for CodeQL to upload results

jobs:
  changed-meta:
    name: Detect meta/config changes
    runs-on: ubuntu-latest
    outputs:
      meta: ${{ steps.filter.outputs.meta }}
      always_scan: ${{ steps.vars.outputs.always_scan }}
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          fetch-depth: 0
      - name: Set baseline scan flag
        id: vars
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "push" ] && [ "${{ github.ref }}" = "refs/heads/main" ]; then
            echo "always_scan=true" >> "$GITHUB_OUTPUT"
          else
            echo "always_scan=false" >> "$GITHUB_OUTPUT"
          fi
      - name: Filter changed paths
        id: filter
        uses: dorny/paths-filter@v3
        with:
          filters: |
            meta:
              - '.github/**'
              - 'infra/**'
              - 'scripts/**'
              - '**/*.yml'
              - '**/*.yaml'
              - '**/*.json'
              - 'Dockerfile'
              - 'Dockerfile.*'
  labeler:
    name: Label PRs
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write
    steps:
      - name: Checkout repository
        # Pinned to v4 commit hash for security
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Run Labeler
        # Pinned to v5 commit hash for security
        uses: actions/labeler@8558fd74291d67161a8a78ce36a881fa63b766a9 # v5
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
          configuration-path: .github/labeler.yaml

  super-linter:
    name: Super Linter
    runs-on: ubuntu-latest
    needs: [changed-meta]
    if: needs.changed-meta.outputs.always_scan == 'true' || needs.changed-meta.outputs.meta == 'true'
    timeout-minutes: 15
    permissions:
      contents: read
      packages: read
      statuses: write # Required to report status checks
    steps:
      - name: Checkout repository
        # Pinned to v4 commit hash for security
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
        with:
          # Full git history is needed to get a proper list of changed files within `super-linter`
          fetch-depth: 0
      - name: Lint Code Base
        # Pinned to v5 commit hash for security
        uses: github/super-linter@45fc0d88288beee4701c62761281edfee85655d7 # v5
        env:
          # Only lint changed files on PRs to speed up runs; lint full repo only on push to main
          VALIDATE_ALL_CODEBASE: ${{ github.event_name == 'push' && github.ref == 'refs/heads/main' }}
          DEFAULT_BRANCH: main
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Skip files ignored by .gitignore to reduce work
          IGNORE_GITIGNORED_FILES: true
          # Exclude heavy/generated paths (build artifacts, dist, caches, node_modules, coverage, reports)
          FILTER_REGEX_EXCLUDE: >-
            (^build/|/build/|^dist/|/dist/|^coverage/|/coverage/|^node_modules/|/node_modules/|^client/.*/dist/|^server/.*/build/|^docs/.*/dist/|^build-logic/.*/build/|^.*/reports/)
          # We already lint Kotlin and JS/TS with Detekt and Biome in dedicated jobs; disable here to avoid duplication
          VALIDATE_KOTLIN: false
          VALIDATE_JAVASCRIPT_ES: false
          VALIDATE_TYPESCRIPT_ES: false
          VALIDATE_MARKDOWN: false # handled by dedicated markdown job
          # Keep lightweight, fast checks enabled by default (YAML/JSON/GitHub Actions/Shell/Dockerfile)
          # Example if you want to force-enable some:
          # VALIDATE_YAML: true
          # VALIDATE_JSON: true
          # VALIDATE_GITHUB_ACTIONS: true
          # VALIDATE_SHELL_SH: true
          # VALIDATE_DOCKERFILE_HADOLINT: true

  dependency-review:
    name: Dependency Review
    runs-on: ubuntu-latest
    permissions:
      contents: read # Required to read dependency files
      pull-requests: write # Required to comment on PRs
    steps:
      - name: Checkout repository
        # Pinned to v4 commit hash for security
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Dependency Review
        # Pinned to v4 commit hash for security
        uses: actions/dependency-review-action@45529485b5eb76184ced07362d2331fd9d26f03f # v4
        continue-on-error: true # Allow workflow to continue if dependency graph or GitHub Advanced Security is not enabled
        with:
          # You can specify configuration options here, e.g.:
          # fail-on-severity: critical
          # allow-licenses: Apache-2.0, MIT
          # deny-licenses: GPL-3.0
          comment-summary-in-pr: always # Add a summary comment to PRs

  owasp-dependency-check:
    name: OWASP Dependency Check
    runs-on: ubuntu-latest
    permissions:
      contents: read # To read dependency files
      # issues: write # If you want to create issues for vulnerabilities (optional)
      # pull-requests: write # If you want to comment on PRs (optional)
    steps:
      - name: Checkout repository
        # Pinned to v4 commit hash for security
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Run OWASP Dependency Check
        uses: dependency-check/Dependency-Check_Action@2ba636726705b0f74f126ebeaacaf2ad4600b967
        with:
          project: "Loomify-monorepo"
          path: "."
          format: "HTML" # You can choose other formats like XML, JSON, CSV
          # Optional: specify suppression file if you have one
          # suppressionPath: 'config/owasp/owasp-suppression.xml'
          # Optional: fail the build if vulnerabilities are found
        # Optional: Upload the report as an artifact
      - name: Upload OWASP Dependency Check Report
        if: always() # Ensure report is uploaded even if previous steps fail
        # Pinned to v4 commit hash for security
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: owasp-dependency-check-report
          path: reports/dependency-check-report.html # Default path for HTML report
          retention-days: 7

  backend:
    name: Backend
    uses: ./.github/workflows/backend-ci.yml
    secrets:
      NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  frontend:
    name: Frontend
    uses: ./.github/workflows/frontend-ci.yml
    secrets:
      CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}

  test:
    name: Test
    needs: [backend, frontend]
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        # Pinned to v4 commit hash for security
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Setup Java
        uses: ./.github/actions/setup/java
        with:
          java-version: "21"
          distribution: "temurin"

      - name: Setup Node.js and pnpm
        uses: ./.github/actions/setup/node
        with:
          node-version: "22"

      - name: Download backend artifacts
        # Pinned to v4 commit hash for security
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: backend-artifacts
          path: backend-artifacts

      - name: Download frontend artifacts
        # Pinned to v4 commit hash for security
        uses: actions/download-artifact@d3f86a106a0bac45b974a628896c90dbdf5c8093 # v4
        with:
          name: frontend-artifacts
          path: frontend-artifacts

      - name: Run tests
        run: |
          cd backend
          ./gradlew test

      - name: Generate test report
        run: |
          mkdir -p test-report
          cp backend/build/reports/tests/test/* test-report/ || true

      - name: Upload test report
        # Pinned to v4 commit hash for security
        uses: actions/upload-artifact@ea165f8d65b6e75b540449e92b4886f43607fa02 # v4
        with:
          name: test-report
          path: test-report/
          retention-days: 7

  markdown:
    name: Markdown lint (docs)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4
      - name: Markdownlint
        uses: DavidAnson/markdownlint-cli2-action@451cad2cde7304d9c243aaaf2e894d74b428c4be
        with:
          globs: |
            **/*.md
            **/*.mdx
            !.github/copilot-instructions.md
            !.github/prompts/*speckit*
            !.specify/**
            !CLAUDE.md
            !GEMINI.md
            !node_modules/**
            !dist/**
            !build/**
          config: .markdownlint.json

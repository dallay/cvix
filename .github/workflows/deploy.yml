name: Deploy

on:
  workflow_dispatch:
    inputs:
      environment:
        description: "Environment to deploy to"
        type: choice
        options:
          - development
          - staging
          - production
        default: "development"
        required: true
      tag:
        description: "Image tag to deploy (e.g., v1.0.0)"
        type: string
        required: true

concurrency:
  group: deploy-${{ github.ref_name }}-${{ github.event.inputs.environment }}
  cancel-in-progress: false

permissions:
  contents: read
  id-token: write # Required for OIDC authentication with AWS

jobs:
  deploy:
    name: Deploy to ${{ github.event.inputs.environment }}
    runs-on: ubuntu-latest
    environment:
      name: ${{ github.event.inputs.environment }}
      url: https://${{ github.event.inputs.environment }}.loomify.com
    steps:
      - name: Checkout repository
        uses: actions/checkout@08eba0b27e820071cde6df949e0beb9ba4906955 # v4

      - name: Configure AWS Credentials
        uses: aws-actions/configure-aws-credentials@e3dd6a41607377d332191f92661f174033210ad7 # v4
        with:
          role-to-assume: arn:aws:iam::${{ secrets.AWS_ACCOUNT_ID }}:role/github-actions-deploy-role
          aws-region: ${{ secrets.AWS_REGION }}

      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@062f4456476976009c2842e28f676ff916764366 # v2

      - name: Deploy Backend
        uses: ./.github/actions/docker/backend
        with:
          environment: ${{ github.event.inputs.environment }}
          image-tag: ${{ github.event.inputs.tag }}
          ecr-registry: ${{ steps.login-ecr.outputs.registry }}
          aws-region: ${{ secrets.AWS_REGION }}
          aws-account-id:
            ${{ secrets.AWS_ACCOUNT_ID }}
            # Pass secrets for backend configuration
          NVD_API_KEY: ${{ secrets.NVD_API_KEY }}
          DATABASE_URL: ${{ secrets.DATABASE_URL }}
          DATABASE_USERNAME: ${{ secrets.DATABASE_USERNAME }}
          DATABASE_PASSWORD: ${{ secrets.DATABASE_PASSWORD }}
          OAUTH2_SERVER_URL: ${{ secrets.OAUTH2_SERVER_URL }}
          REALM: ${{ secrets.REALM }}
          CLIENT_ID: ${{ secrets.CLIENT_ID }}
          CLIENT_SECRET: ${{ secrets.CLIENT_SECRET }}
          ADMIN_CLIENT_ID: ${{ secrets.ADMIN_CLIENT_ID }}
          ADMIN_REALM: ${{ secrets.ADMIN_REALM }}
          ADMIN_REALM_USERNAME: ${{ secrets.ADMIN_REALM_USERNAME }}
          ADMIN_REALM_PASSWORD: ${{ secrets.ADMIN_REALM_PASSWORD }}
          CORS_ALLOWED_ORIGINS: ${{ secrets.CORS_ALLOWED_ORIGINS }}
          HOSTNAME: ${{ secrets.HOSTNAME }}
          SMTP_HOST: ${{ secrets.SMTP_HOST }}
          SMTP_PORT: ${{ secrets.SMTP_PORT }}
          SMTP_USERNAME: ${{ secrets.SMTP_USERNAME }}
          SMTP_PASSWORD: ${{ secrets.SMTP_PASSWORD }}
          SENDGRID_API_KEY: ${{ secrets.SENDGRID_API_KEY }}

      - name: Deploy Frontend Web App
        uses: ./.github/actions/docker/frontend-web
        with:
          environment: ${{ github.event.inputs.environment }}
          image-tag: ${{ github.event.inputs.tag }}
          ecr-registry: ${{ steps.login-ecr.outputs.registry }}
          aws-region: ${{ secrets.AWS_REGION }}
          aws-account-id:
            ${{ secrets.AWS_ACCOUNT_ID }}
            # Pass secrets for frontend configuration
          VITE_API_BASE_URL: ${{ secrets.VITE_API_BASE_URL }}
          VITE_KEYCLOAK_URL: ${{ secrets.VITE_KEYCLOAK_URL }}
          VITE_KEYCLOAK_REALM: ${{ secrets.VITE_KEYCLOAK_REALM }}
          VITE_KEYCLOAK_CLIENT_ID: ${{ secrets.VITE_KEYCLOAK_CLIENT_ID }}
          VITE_KEYCLOAK_REDIRECT_URI: ${{ secrets.VITE_KEYCLOAK_REDIRECT_URI }}
          VITE_KEYCLOAK_SCOPE: ${{ secrets.VITE_KEYCLOAK_SCOPE }}
          VITE_KEYCLOAK_RESPONSE_MODE: ${{ secrets.VITE_KEYCLOAK_RESPONSE_MODE }}
          VITE_KEYCLOAK_RESPONSE_TYPE: ${{ secrets.VITE_KEYCLOAK_RESPONSE_TYPE }}
          VITE_KEYCLOAK_POST_LOGOUT_REDIRECT_URI: ${{ secrets.VITE_KEYCLOAK_POST_LOGOUT_REDIRECT_URI }}
          VITE_KEYCLOAK_REFRESH_TOKEN_INTERVAL: ${{ secrets.VITE_KEYCLOAK_REFRESH_TOKEN_INTERVAL }}
          VITE_SENTRY_DSN: ${{ secrets.VITE_SENTRY_DSN }}
          VITE_SENTRY_ENVIRONMENT: ${{ github.event.inputs.environment }}
          VITE_SENTRY_RELEASE: ${{ github.event.inputs.tag }}

      - name: Deploy Frontend Landing Page
        uses: ./.github/actions/docker/frontend-landing
        with:
          base-url: ${{ secrets.BASE_URL }}
          build-env: production
          context: ./frontend
          deliver: true
          docker: true
          PUBLIC_API_BASE_URL: ${{ secrets.PUBLIC_API_BASE_URL }}
          PUBLIC_KEYCLOAK_URL: ${{ secrets.PUBLIC_KEYCLOAK_URL }}
          PUBLIC_KEYCLOAK_REALM: ${{ secrets.PUBLIC_KEYCLOAK_REALM }}
          PUBLIC_KEYCLOAK_CLIENT_ID: ${{ secrets.PUBLIC_KEYCLOAK_CLIENT_ID }}
          PUBLIC_KEYCLOAK_REDIRECT_URI: ${{ secrets.PUBLIC_KEYCLOAK_REDIRECT_URI }}
          PUBLIC_KEYCLOAK_SCOPE: ${{ secrets.PUBLIC_KEYCLOAK_SCOPE }}
          PUBLIC_KEYCLOAK_RESPONSE_MODE: ${{ secrets.PUBLIC_KEYCLOAK_RESPONSE_MODE }}
          PUBLIC_KEYCLOAK_RESPONSE_TYPE: ${{ secrets.PUBLIC_KEYCLOAK_RESPONSE_TYPE }}
          PUBLIC_KEYCLOAK_POST_LOGOUT_REDIRECT_URI: ${{ secrets.PUBLIC_KEYCLOAK_POST_LOGOUT_REDIRECT_URI }}
          PUBLIC_KEYCLOAK_REFRESH_TOKEN_INTERVAL: ${{ secrets.PUBLIC_KEYCLOAK_REFRESH_TOKEN_INTERVAL }}
          PUBLIC_SENTRY_DSN: ${{ secrets.PUBLIC_SENTRY_DSN }}
          PUBLIC_SENTRY_ENVIRONMENT: ${{ github.event.inputs.environment }}
          PUBLIC_SENTRY_RELEASE: ${{ github.event.inputs.tag }}

      - name: Run Security Scan
        uses: ./.github/actions/docker/security-scan
        with:
          category: <replace-with-category>
          image-ref: <replace-with-image-ref>
          report-name: <replace-with-report-name>

      - name: Post-deployment Smoke Tests
        run:
          echo "Running smoke tests..."
          # Add actual smoke tests here, e.g., curl to health endpoints

      - name: Notify on Success
        if: success()
        run: echo "Deployment to ${{ github.event.inputs.environment }} successful!"

      - name: Notify on Failure
        if: failure()
        run: echo "Deployment to ${{ github.event.inputs.environment }} failed!"

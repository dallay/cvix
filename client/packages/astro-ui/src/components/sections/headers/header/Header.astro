---
import { cn } from "@cvix/lib";
import type { HTMLAttributes } from "astro/types";
import { Brand } from "../../../blocks/brand";
import { ThemeToggle } from "../../../blocks/theme-toggle";
import LocaleSelect from "../../../i18n/LocaleSelect.astro";

interface Props extends HTMLAttributes<"header"> {}
const { ...attrs } = Astro.props as Props;
---

<header
  id="header"
  class={cn(
    "fixed top-0 left-0 w-full z-[6000] bg-transparent border-b border-b-slate-300 dark:border-b-slate-700",
    "transition-all duration-400 ease-in-out [transition-property:top,background-color,border-bottom-color]",
  )}
  {...attrs}
>
  <div class="container mx-auto px-4 flex items-center h-20 relative">
    <div class="flex items-center mr-10">
      <Brand siteTitle="ProfileTailors" />
    </div>

    <div class="mx-2 flex items-center justify-center">
      <slot name="nav" />
    </div>

    <div class="flex items-center justify-center gap-4 ml-auto">
      <ThemeToggle />
      <LocaleSelect variant="text" class="hidden md:inline-flex" />
      <slot name="cta" />
    </div>
  </div>
</header>

<style>
  /* Header states */
  header {
    background-color: transparent;
    transform: translateY(0);
  }

  header.scrolled {
    border-bottom-width: 1px;
    border-bottom-color: rgb(203 213 225 / 0.6);
    background-color: white;
  }

  :global(.dark) header.scrolled {
    border-bottom-color: rgb(51 65 85 / 0.6);
    background-color: rgb(17 24 39);
  }

  /* Alternative approach using CSS variables */
  header.scrolled #site-title,
  header.scrolled nav a,
  header.scrolled button:not(.bg-white):not(.bg-gray-900) {
    color: var(--colors-main-light);
  }

  :global(.dark) header.scrolled #site-title,
  :global(.dark) header.scrolled nav a,
  :global(.dark) header.scrolled button:not(.bg-white):not(.bg-gray-900) {
    color: var(--colors-main-dark);
  }

  header.scrolled nav a:hover {
    color: rgb(107 114 128);
  }

  :global(.dark) header.scrolled nav a:hover {
    color: rgb(156 163 175);
  }

  header.hide {
    transform: translateY(-100%);
  }
</style>

<script>
  // Handle colored-hero classes for button styling
  const header = document.getElementById("header");
  const heroSection = document.querySelector(".hero-section");

  // Check if we're on a page with a colored hero
  if (heroSection && heroSection.classList.contains("colored-hero")) {
    document.body.classList.add("colored-hero");
  }

  // Header scroll behavior (throttled)
  let lastScrollY = 0;
  let ticking = false;

  const handleHeaderVisibility = () => {
    if (!header) return;
    const y = window.scrollY;
    if (y <= 50) {
      // Reset when at or above 50px from top
      header.classList.remove("hide", "scrolled");
    } else if (y < lastScrollY) {
      // Scrolling up past 50px
      header.classList.remove("hide");
      header.classList.add("scrolled");
    } else {
      // Scrolling down past 50px
      header.classList.add("hide");
    }
    lastScrollY = y;
  };

  // Throttle scroll handler to one per animation frame
  const onScroll = () => {
    if (!ticking) {
      ticking = true;
      requestAnimationFrame(() => {
        handleHeaderVisibility();
        ticking = false;
      });
    }
  };

  // Initialize header state
  handleHeaderVisibility();
  window.addEventListener("scroll", onScroll, { passive: true });
</script>

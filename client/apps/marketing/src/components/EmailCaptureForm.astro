---
import type { HTMLAttributes } from "astro/types";
import { cn } from "@cvix/ui/lib/utils";
import { BACKEND_URL } from "astro:env/client";
import {type Lang, useTranslations} from "@i18n";


interface Props extends HTMLAttributes<"div"> {
	emailPlaceholder?: string;
	buttonText?: string;
	successMessage?: string;
	errorMessage?: string;
	rateLimitMessage?: string;
	source?: string;
}

const {
	emailPlaceholder = "Enter your email",
	buttonText = "Join",
	successMessage,
	errorMessage,
	rateLimitMessage,
	source = "email-capture-form",
	class: className,
	...attrs
} = Astro.props;

const fullApiUrl = `${BACKEND_URL}/api/waitlist`;

// Generate unique ID for this form instance
const formId = `email-form-${crypto.randomUUID()}`;
const currentLocale = Astro.currentLocale as Lang;
const t = useTranslations(currentLocale);
---

<div class={cn("flex flex-col gap-4 w-full max-w-sm", className)} {...attrs}>
	<form id={formId} class="flex gap-2" data-api-url={fullApiUrl} data-source={source}>
    <label>
      <span class="sr-only">{t('emailCaptureForm.emailLabel')}</span>
      <input
        type="email"
        name="email"
        required
        placeholder={emailPlaceholder}
        class={cn(
          "file:text-foreground placeholder:text-muted-foreground selection:bg-primary selection:text-primary-foreground dark:bg-input/30 border-input flex h-9 w-full min-w-0 rounded-md border bg-transparent px-3 py-1 text-base shadow-xs transition-[color,box-shadow] outline-none file:inline-flex file:h-7 file:border-0 file:bg-transparent file:text-sm file:font-medium disabled:pointer-events-none disabled:cursor-not-allowed disabled:opacity-50 md:text-sm",
          "focus-visible:border-ring focus-visible:ring-ring/50 focus-visible:ring-[3px]",
          "aria-invalid:ring-destructive/20 dark:aria-invalid:ring-destructive/40 aria-invalid:border-destructive"
        )}
      />
    </label>
    <button
			type="submit"
			class={cn(
				"inline-flex items-center justify-center gap-2 whitespace-nowrap rounded-md text-sm font-medium transition-colors",
				"focus-visible:outline-none focus-visible:ring-1 focus-visible:ring-ring",
				"disabled:pointer-events-none disabled:opacity-50",
				"[&_svg]:pointer-events-none [&_svg]:size-4 [&_svg]:shrink-0",
				"bg-primary text-primary-foreground shadow hover:bg-primary/90",
				"h-9 px-4 py-2"
			)}
		>
			<span class="button-text">{buttonText}</span>
		</button>
	</form>

	<!-- Status Messages -->
	<div
		class="status-message hidden text-sm px-3 py-2 rounded-md transition-opacity duration-300"
		role="alert"
		aria-live="polite"
	>
	</div>
</div>

<!-- Load CSRF helper and expose globally for inline script -->
<script>
	import { csrfLoader, getCsrfToken } from "@/utils/csrf";

	// Expose globally for inline script compatibility
	window.csrfLoader = csrfLoader;
	window.getCsrfToken = getCsrfToken;
</script>

<script is:inline define:vars={{ successMessage, errorMessage, rateLimitMessage }}>
	// Email validation regex
	const EMAIL_REGEX = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
	
	// Auto-hide message timeout (in milliseconds)
	const MESSAGE_AUTO_HIDE_MS = 5000;

	/**
	 * Normalize browser language to backend-supported language code
	 * Backend only accepts 'en' or 'es'
	 *
	 * @param {string} browserLang - Browser language (e.g., 'en-US', 'es-ES', 'en', 'es')
	 * @returns {string} Normalized language code ('en' or 'es')
	 */
	function normalizeLanguage(browserLang) {
		if (!browserLang) return "en";

		// Extract base language code (first two chars before '-' or '_')
		const baseLang = browserLang.toLowerCase().split(/[-_]/)[0];

		// Return 'es' for Spanish, 'en' for everything else
		return baseLang === "es" ? "es" : "en";
	}

	// Initialize all forms on the page
	document.addEventListener("DOMContentLoaded", () => {
		const forms = document.querySelectorAll('form[id^="email-form-"]');

		forms.forEach((form) => {
			if (!(form instanceof HTMLFormElement)) return;

			const emailInput = form.querySelector('input[type="email"]');
			const submitButton = form.querySelector('button[type="submit"]');
			const buttonText = submitButton?.querySelector(".button-text");
			const statusMessage = form.parentElement?.querySelector(".status-message");

			if (!emailInput || !submitButton || !buttonText || !statusMessage) return;

			let retryInterval = null;
			let retryAfter = 0;

			// Lazy load CSRF token on first interaction with the form
			// This avoids unnecessary requests on pages where the form is never used
			const lazyLoadCsrf = () => {
				const backendUrl = form.getAttribute("data-api-url")?.replace("/api/waitlist", "");
				if (backendUrl) {
					window.csrfLoader.ensureToken(backendUrl).catch((err) => {
						console.warn("CSRF lazy load failed:", err);
					});
				}
			};

			// Initialize CSRF on first focus or input
			emailInput.addEventListener("focus", lazyLoadCsrf, { once: true });
			emailInput.addEventListener("input", lazyLoadCsrf, { once: true });

			// Validate email on input
			emailInput.addEventListener("input", () => {
				const email = emailInput.value;
				const isValid = EMAIL_REGEX.test(email);
				emailInput.setAttribute("aria-invalid", isValid ? "false" : "true");
				submitButton.disabled = !isValid || retryAfter > 0;
			});

			// Handle Enter key
			emailInput.addEventListener("keydown", (e) => {
				if (e.key === "Enter" && !submitButton.disabled) {
					e.preventDefault();
					form.dispatchEvent(new Event("submit"));
				}
			});

			// Show status message
			const showMessage = (message, type) => {
				statusMessage.textContent = message;
				statusMessage.className = `status-message text-sm px-3 py-2 rounded-md transition-opacity duration-300 ${
					type === "success"
						? "text-green-700 bg-green-50 dark:text-green-300 dark:bg-green-950/30"
						: type === "error"
							? "text-red-700 bg-red-50 dark:text-red-300 dark:bg-red-950/30"
							: "text-blue-700 bg-blue-50 dark:text-blue-300 dark:bg-blue-950/30"
				}`;
				statusMessage.classList.remove("hidden");
			};

			const hideMessage = () => {
				statusMessage.classList.add("hidden");
			};

			// Start countdown timer
			const startCountdown = (seconds) => {
				retryAfter = seconds;
				submitButton.disabled = true;
				emailInput.disabled = true;

				if (retryInterval) clearInterval(retryInterval);

				retryInterval = setInterval(() => {
					retryAfter--;
					buttonText.textContent = `${retryAfter}s`;

					if (retryAfter <= 0) {
						clearInterval(retryInterval);
						retryInterval = null;
						buttonText.textContent =
							submitButton.getAttribute("data-original-text") || "Join";
						submitButton.disabled = false;
						emailInput.disabled = false;
						hideMessage();
					}
				}, 1000);
			};

			// Handle form submission
			form.addEventListener("submit", async (e) => {
				e.preventDefault();

				const email = emailInput.value.trim();
				if (!EMAIL_REGEX.test(email) || submitButton.disabled) return;

				// Store original button text
				const originalText = buttonText.textContent;
				submitButton.setAttribute("data-original-text", originalText);

				// Show loading state
				buttonText.textContent = "...";
				submitButton.disabled = true;

				try {
					const apiUrl = form.getAttribute("data-api-url");
					const source = form.getAttribute("data-source");

					// Ensure CSRF token is loaded before submitting
					const backendUrl = apiUrl?.replace("/api/waitlist", "");
					if (backendUrl) {
						await window.csrfLoader.ensureToken(backendUrl);
					}

					// Get CSRF token from cookie and add to headers
					const csrfToken = window.getCsrfToken();
					const headers = {
						"Content-Type": "application/json",
						Accept: "application/vnd.api.v1+json",
					};

					// Add CSRF token header if available
					if (csrfToken) {
						headers["X-XSRF-TOKEN"] = csrfToken;
					}

					// Normalize language from browser (e.g., 'en-US' -> 'en')
					const normalizedLanguage = normalizeLanguage(navigator.language || "en");

					const response = await fetch(apiUrl, {
						method: "POST",
						headers,
						body: JSON.stringify({
							email,
							source,
							language: normalizedLanguage
						}),
						credentials: "include",
					});

					if (response.ok) {
						// Success
						const data = await response.json();
						const message =
							successMessage ||
							data.message ||
							"Successfully joined the waitlist!";
						showMessage(message, "success");
						emailInput.value = "";

					// Store in localStorage
					try {
						localStorage.setItem("waitlist_email", email);
					} catch {}

					// Auto-hide after configured timeout
					setTimeout(hideMessage, MESSAGE_AUTO_HIDE_MS);
					} else if (response.status === 429) {
						// Rate limited
						const retryAfterHeader = response.headers.get("Retry-After");
						const retrySeconds = retryAfterHeader
							? parseInt(retryAfterHeader, 10)
							: 60;

						const message =
							rateLimitMessage ||
							`Too many requests. Please try again in ${retrySeconds} seconds.`;
						showMessage(message, "info");
						startCountdown(retrySeconds);
					} else {
						// Other errors
						const errorData = await response.json().catch(() => ({}));
					const message =
						errorMessage ||
						errorData.error?.message ||
						errorData.message ||
						"Failed to submit. Please try again.";
					showMessage(message, "error");

					// Auto-hide after configured timeout
					setTimeout(hideMessage, MESSAGE_AUTO_HIDE_MS);
					}
				} catch (err) {
					console.error("Email submission error:", err);
					const message =
						errorMessage || "Network error. Please check your connection.";
					showMessage(message, "error");

					// Auto-hide after configured timeout
					setTimeout(hideMessage, MESSAGE_AUTO_HIDE_MS);
				} finally {
					if (retryAfter === 0) {
						buttonText.textContent = originalText;
						submitButton.disabled = false;
					}
				}
			});
		});
	});
</script>
